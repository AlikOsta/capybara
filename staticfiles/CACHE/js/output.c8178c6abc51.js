document.addEventListener('DOMContentLoaded',function(){initFavoriteButtons();});document.addEventListener('htmx:afterSwap',function(){initFavoriteButtons();});function initFavoriteButtons(){const favoriteBtns=document.querySelectorAll('.favorite-btn:not(.initialized)');favoriteBtns.forEach(btn=>{btn.classList.add('initialized');btn.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();const productId=this.dataset.productId;const isFavorite=this.dataset.isFavorite==='true';this.classList.add('clicked');setTimeout(()=>{this.classList.remove('clicked');},300);fetch(`/product/${productId}/favorite/`,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'},body:JSON.stringify({})}).then(response=>{if(!response.ok){throw new Error(`Network error: ${response.status}`);}
return response.json();}).then(data=>{if(data.success){this.dataset.isFavorite=data.is_favorite.toString();const icon=this.querySelector('i');if(data.is_favorite){icon.classList.remove('bi-heart');icon.classList.add('bi-heart-fill');}else{icon.classList.remove('bi-heart-fill');icon.classList.add('bi-heart');if(window.location.pathname.includes('/favorites/')||document.querySelector('.favorites-page')){document.body.dispatchEvent(new CustomEvent('favoriteListChanged',{bubbles:true}));}}}}).catch(error=>{alert('Произошла ошибка при обновлении избранного. Пожалуйста, попробуйте еще раз.');});});});}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
window.initFavoriteButtons=initFavoriteButtons;;const TelegramApp=(function(){let _tg=null;let _isInitialized=false;let _eventHandlers={};const _checkAvailability=function(){return window.Telegram&&window.Telegram.WebApp;};const _safeExecute=function(callback,fallback){try{if(_isInitialized&&_tg){return callback(_tg);}else{console.warn('Telegram WebApp не инициализирован');if(typeof fallback==='function'){return fallback();}}}catch(error){console.error('Ошибка при выполнении операции Telegram WebApp:',error);if(typeof fallback==='function'){return fallback();}}
return null;};return{init:function(){if(_isInitialized)return true;if(_checkAvailability()){_tg=window.Telegram.WebApp;_isInitialized=true;_tg.expand();this.adaptTheme();console.log('Telegram WebApp успешно инициализирован');return true;}else{console.warn('Telegram WebApp API недоступен');return false;}},getWebApp:function(){return _tg;},adaptTheme:function(){_safeExecute(function(tg){const isDarkTheme=tg.colorScheme==='dark';document.body.setAttribute('data-bs-theme',isDarkTheme?'dark':'light');document.documentElement.style.setProperty('--tg-theme-bg-color',tg.themeParams.bg_color||'#ffffff');document.documentElement.style.setProperty('--tg-theme-text-color',tg.themeParams.text_color||'#000000');document.documentElement.style.setProperty('--tg-theme-hint-color',tg.themeParams.hint_color||'#999999');document.documentElement.style.setProperty('--tg-theme-link-color',tg.themeParams.link_color||'#2481cc');document.documentElement.style.setProperty('--tg-theme-button-color',tg.themeParams.button_color||'#2481cc');document.documentElement.style.setProperty('--tg-theme-button-text-color',tg.themeParams.button_text_color||'#ffffff');document.documentElement.style.setProperty('--tg-theme-secondary-bg-color',tg.themeParams.secondary_bg_color||'#f0f0f0');});},setupBackButton:function(callback){return _safeExecute(function(tg){if(!tg.BackButton){console.warn('BackButton недоступен');return false;}
tg.BackButton.show();if(_eventHandlers.backButton){tg.offEvent('backButtonClicked',_eventHandlers.backButton);}
_eventHandlers.backButton=function(){TelegramApp.hapticFeedback('impact','medium');if(typeof callback==='function'){callback();}else{window.history.back();}};tg.onEvent('backButtonClicked',_eventHandlers.backButton);return true;},function(){return false;});},hideBackButton:function(){return _safeExecute(function(tg){if(tg.BackButton){tg.BackButton.hide();return true;}
return false;},function(){return false;});},setupMainButton:function(options={}){return _safeExecute(function(tg){if(!tg.MainButton){console.warn('MainButton недоступен');return false;}
const defaults={text:'Продолжить',color:tg.themeParams.button_color||'#2481cc',textColor:tg.themeParams.button_text_color||'#ffffff',onClick:null,isVisible:true,isActive:true,progressVisible:false};const settings={...defaults,...options};tg.MainButton.setText(settings.text);tg.MainButton.setParams({color:settings.color,text_color:settings.textColor,is_active:settings.isActive,is_visible:settings.isVisible});if(_eventHandlers.mainButton){tg.MainButton.offClick(_eventHandlers.mainButton);}
if(settings.onClick){_eventHandlers.mainButton=function(){TelegramApp.hapticFeedback('impact','medium');settings.onClick();};tg.MainButton.onClick(_eventHandlers.mainButton);}
if(settings.progressVisible){tg.MainButton.showProgress();}else{tg.MainButton.hideProgress();}
if(settings.isVisible){tg.MainButton.show();}else{tg.MainButton.hide();}
return true;},function(){return false;});},hideMainButton:function(){return _safeExecute(function(tg){if(tg.MainButton){tg.MainButton.hide();return true;}
return false;},function(){return false;});},showMainButton:function(){return _safeExecute(function(tg){if(tg.MainButton){tg.MainButton.show();return true;}
return false;},function(){return false;});},hapticFeedback:function(type='impact',intensity='medium'){return _safeExecute(function(tg){if(!tg.HapticFeedback){console.warn('HapticFeedback недоступен');return false;}
switch(type){case'impact':tg.HapticFeedback.impactOccurred(intensity);break;case'notification':tg.HapticFeedback.notificationOccurred(intensity);break;case'selection':tg.HapticFeedback.selectionChanged();break;default:console.warn('Неизвестный тип тактильной обратной связи:',type);return false;}
return true;},function(){return false;});},close:function(){_safeExecute(function(tg){tg.close();});},getInitData:function(){return _safeExecute(function(tg){return tg.initData||null;},function(){return null;});},getUser:function(){return _safeExecute(function(tg){return tg.initDataUnsafe&&tg.initDataUnsafe.user?tg.initDataUnsafe.user:null;},function(){return null;});},isAvailable:function(){return _checkAvailability();},isInitialized:function(){return _isInitialized;},getColorScheme:function(){return _safeExecute(function(tg){return tg.colorScheme||'light';},function(){return'light';});},getThemeParams:function(){return _safeExecute(function(tg){return tg.themeParams||{};},function(){return{};});}};})();document.addEventListener('DOMContentLoaded',function(){TelegramApp.init();});;document.addEventListener('DOMContentLoaded',()=>{const tg=window.Telegram&&window.Telegram.WebApp;if(tg){if(typeof adaptThemeToTelegram==='function'){adaptThemeToTelegram(tg);}}});;document.addEventListener('DOMContentLoaded',function(){const productDetail=document.querySelector('.product-detail');if(!productDetail)return;const isAuthor=productDetail.dataset.isAuthor==='true';const productId=productDetail.dataset.productId;const productTitle=productDetail.dataset.productTitle;const productPrice=productDetail.dataset.productPrice;setupTelegramButtons(isAuthor,productId,productTitle,productPrice);setupFavoriteButton();});function setupTelegramButtons(isAuthor,productId,productTitle,productPrice){if(!TelegramApp.isInitialized())return;TelegramApp.setupBackButton();if(!isAuthor){TelegramApp.setupMainButton({text:'Написать продавцу',onClick:function(){const sellerUsername=document.querySelector('.product-detail').dataset.username;if(!sellerUsername)return;const message=`Здравствуйте! Интересует товар "${productTitle}" за ${productPrice}`;const tg=TelegramApp.getWebApp();if(tg&&tg.openTelegramLink){tg.openTelegramLink(`https://t.me/${sellerUsername}?start=product_${productId}`);}else{window.open(`https://t.me/${sellerUsername}?start=product_${productId}`,'_blank');}}});}
window.addEventListener('beforeunload',function(){TelegramApp.hideBackButton();TelegramApp.hideMainButton();});}
function setupFavoriteButton(){const favoriteButtons=document.querySelectorAll('.favorite-btn');favoriteButtons.forEach(button=>{button.addEventListener('click',function(e){e.preventDefault();if(TelegramApp.isInitialized()){TelegramApp.hapticFeedback('selection');}
const productId=this.dataset.productId;const isFavorite=this.dataset.isFavorite==='true';const icon=this.querySelector('i');this.dataset.isFavorite=!isFavorite;icon.classList.toggle('bi-heart');icon.classList.toggle('bi-heart-fill');fetch(`/product/${productId}/favorite/`,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken')}}).then(response=>{if(!response.ok){throw new Error('Ошибка сети');}
return response.json();}).then(data=>{if(!data.success){this.dataset.isFavorite=isFavorite;icon.classList.toggle('bi-heart');icon.classList.toggle('bi-heart-fill');}}).catch(error=>{console.error('Ошибка при обновлении избранного:',error);this.dataset.isFavorite=isFavorite;icon.classList.toggle('bi-heart');icon.classList.toggle('bi-heart-fill');});});});}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;};