document.addEventListener('DOMContentLoaded',function(){initFavoriteButtons();});document.addEventListener('htmx:afterSwap',function(){initFavoriteButtons();});function initFavoriteButtons(){const favoriteBtns=document.querySelectorAll('.favorite-btn:not(.initialized)');favoriteBtns.forEach(btn=>{btn.classList.add('initialized');btn.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();const productId=this.dataset.productId;const isFavorite=this.dataset.isFavorite==='true';this.classList.add('clicked');setTimeout(()=>{this.classList.remove('clicked');},300);fetch(`/product/${productId}/favorite/`,{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'},body:JSON.stringify({})}).then(response=>{if(!response.ok){throw new Error(`Network error: ${response.status}`);}
return response.json();}).then(data=>{if(data.success){this.dataset.isFavorite=data.is_favorite.toString();const icon=this.querySelector('i');if(data.is_favorite){icon.classList.remove('bi-heart');icon.classList.add('bi-heart-fill');}else{icon.classList.remove('bi-heart-fill');icon.classList.add('bi-heart');if(window.location.pathname.includes('/favorites/')||document.querySelector('.favorites-page')){document.body.dispatchEvent(new CustomEvent('favoriteListChanged',{bubbles:true}));}}}}).catch(error=>{alert('Произошла ошибка при обновлении избранного. Пожалуйста, попробуйте еще раз.');});});});}
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break;}}}
return cookieValue;}
window.initFavoriteButtons=initFavoriteButtons;;const TelegramApp=(function(){let _tg=null;let _isInitialized=false;let _eventHandlers={};const _checkAvailability=function(){return window.Telegram&&window.Telegram.WebApp;};const _safeExecute=function(callback,fallback){try{if(_isInitialized&&_tg){return callback(_tg);}else{console.warn('Telegram WebApp не инициализирован');if(typeof fallback==='function'){return fallback();}}}catch(error){console.error('Ошибка при выполнении операции Telegram WebApp:',error);if(typeof fallback==='function'){return fallback();}}
return null;};return{init:function(){if(_isInitialized)return true;if(_checkAvailability()){_tg=window.Telegram.WebApp;_isInitialized=true;_tg.expand();this.adaptTheme();console.log('Telegram WebApp успешно инициализирован');return true;}else{console.warn('Telegram WebApp API недоступен');return false;}},getWebApp:function(){return _tg;},adaptTheme:function(){_safeExecute(function(tg){const isDarkTheme=tg.colorScheme==='dark';document.body.setAttribute('data-bs-theme',isDarkTheme?'dark':'light');document.documentElement.style.setProperty('--tg-theme-bg-color',tg.themeParams.bg_color||'#ffffff');document.documentElement.style.setProperty('--tg-theme-text-color',tg.themeParams.text_color||'#000000');document.documentElement.style.setProperty('--tg-theme-hint-color',tg.themeParams.hint_color||'#999999');document.documentElement.style.setProperty('--tg-theme-link-color',tg.themeParams.link_color||'#2481cc');document.documentElement.style.setProperty('--tg-theme-button-color',tg.themeParams.button_color||'#2481cc');document.documentElement.style.setProperty('--tg-theme-button-text-color',tg.themeParams.button_text_color||'#ffffff');document.documentElement.style.setProperty('--tg-theme-secondary-bg-color',tg.themeParams.secondary_bg_color||'#f0f0f0');});},setupBackButton:function(callback){return _safeExecute(function(tg){if(!tg.BackButton){console.warn('BackButton недоступен');return false;}
tg.BackButton.show();if(_eventHandlers.backButton){tg.offEvent('backButtonClicked',_eventHandlers.backButton);}
_eventHandlers.backButton=function(){TelegramApp.hapticFeedback('impact','medium');if(typeof callback==='function'){callback();}else{window.history.back();}};tg.onEvent('backButtonClicked',_eventHandlers.backButton);return true;},function(){return false;});},hideBackButton:function(){return _safeExecute(function(tg){if(tg.BackButton){tg.BackButton.hide();return true;}
return false;},function(){return false;});},setupMainButton:function(options={}){return _safeExecute(function(tg){if(!tg.MainButton){console.warn('MainButton недоступен');return false;}
const defaults={text:'Продолжить',color:tg.themeParams.button_color||'#2481cc',textColor:tg.themeParams.button_text_color||'#ffffff',onClick:null,isVisible:true,isActive:true,progressVisible:false};const settings={...defaults,...options};tg.MainButton.setText(settings.text);tg.MainButton.setParams({color:settings.color,text_color:settings.textColor,is_active:settings.isActive,is_visible:settings.isVisible});if(_eventHandlers.mainButton){tg.MainButton.offClick(_eventHandlers.mainButton);}
if(settings.onClick){_eventHandlers.mainButton=function(){TelegramApp.hapticFeedback('impact','medium');settings.onClick();};tg.MainButton.onClick(_eventHandlers.mainButton);}
if(settings.progressVisible){tg.MainButton.showProgress();}else{tg.MainButton.hideProgress();}
if(settings.isVisible){tg.MainButton.show();}else{tg.MainButton.hide();}
return true;},function(){return false;});},hideMainButton:function(){return _safeExecute(function(tg){if(tg.MainButton){tg.MainButton.hide();return true;}
return false;},function(){return false;});},showMainButton:function(){return _safeExecute(function(tg){if(tg.MainButton){tg.MainButton.show();return true;}
return false;},function(){return false;});},hapticFeedback:function(type='impact',intensity='medium'){return _safeExecute(function(tg){if(!tg.HapticFeedback){console.warn('HapticFeedback недоступен');return false;}
switch(type){case'impact':tg.HapticFeedback.impactOccurred(intensity);break;case'notification':tg.HapticFeedback.notificationOccurred(intensity);break;case'selection':tg.HapticFeedback.selectionChanged();break;default:console.warn('Неизвестный тип тактильной обратной связи:',type);return false;}
return true;},function(){return false;});},close:function(){_safeExecute(function(tg){tg.close();});},getInitData:function(){return _safeExecute(function(tg){return tg.initData||null;},function(){return null;});},getUser:function(){return _safeExecute(function(tg){return tg.initDataUnsafe&&tg.initDataUnsafe.user?tg.initDataUnsafe.user:null;},function(){return null;});},isAvailable:function(){return _checkAvailability();},isInitialized:function(){return _isInitialized;},getColorScheme:function(){return _safeExecute(function(tg){return tg.colorScheme||'light';},function(){return'light';});},getThemeParams:function(){return _safeExecute(function(tg){return tg.themeParams||{};},function(){return{};});}};})();document.addEventListener('DOMContentLoaded',function(){TelegramApp.init();});;document.addEventListener('DOMContentLoaded',()=>{const tg=window.Telegram&&window.Telegram.WebApp;if(tg){if(typeof adaptThemeToTelegram==='function'){adaptThemeToTelegram(tg);}}});;const InfiniteScrollModule={settings:{isLoading:false,offset:0,limit:20,hasMore:true,loadThreshold:70,observerThreshold:0.2,animationDelay:5,loadingTimeout:null},elements:{productsContainer:null,loaderElement:null,endMessageElement:null,errorElement:null,backToTopButton:null,retryButton:null},init(){const{productsContainer,loaderElement,errorElement,retryButton}=this.elements;this.elements.productsContainer=document.getElementById('products-container');this.elements.loaderElement=document.getElementById('loader');this.elements.endMessageElement=document.getElementById('end-message');this.elements.errorElement=document.getElementById('error-message');this.elements.backToTopButton=document.getElementById('back-to-top');this.elements.retryButton=document.getElementById('retry-button');if(!this.elements.productsContainer)return;this.settings.offset=parseInt(this.elements.productsContainer.dataset.offset||'20',10);this.settings.hasMore=this.elements.productsContainer.dataset.hasMore==='true';this.initIntersectionObserver();this.initEventListeners();},initIntersectionObserver(){const{loaderElement}=this.elements;if(!loaderElement)return;const observer=new IntersectionObserver((entries)=>{if(entries[0].isIntersecting&&!this.settings.isLoading&&this.settings.hasMore){this.loadMoreProducts();}},{threshold:this.settings.observerThreshold});observer.observe(loaderElement);},initEventListeners(){window.addEventListener('scroll',()=>this.handleScroll());if(this.elements.retryButton){this.elements.retryButton.addEventListener('click',()=>{if(this.elements.errorElement){this.elements.errorElement.style.display='none';}
this.loadMoreProducts();});}},handleScroll(){const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const scrollHeight=document.documentElement.scrollHeight;const clientHeight=document.documentElement.clientHeight;const scrollPercentage=(scrollTop/(scrollHeight-clientHeight))*100;if(scrollPercentage>=this.settings.loadThreshold&&!this.settings.isLoading&&this.settings.hasMore){clearTimeout(this.settings.loadingTimeout);this.settings.loadingTimeout=setTimeout(()=>{this.loadMoreProducts();},100);}},loadMoreProducts(){if(this.settings.isLoading||!this.settings.hasMore)return;this.settings.isLoading=true;this.showLoader();const apiUrl=this.getApiUrl();if(!apiUrl){this.hideLoader();this.settings.isLoading=false;return;}
fetch(apiUrl).then(response=>{if(!response.ok){throw new Error('Ошибка загрузки данных');}
return response.json();}).then(data=>{if(data.html){this.appendNewProducts(data.html);this.settings.offset=data.next_offset||this.settings.offset;this.settings.hasMore=data.has_more;if(!this.settings.hasMore&&this.elements.endMessageElement){this.elements.endMessageElement.style.display='block';}}}).catch(error=>{console.error('Ошибка:',error);if(this.elements.errorElement){this.elements.errorElement.style.display='block';}}).finally(()=>{this.hideLoader();this.settings.isLoading=false;});},getApiUrl(){const urlParams=new URLSearchParams(window.location.search);const params=new URLSearchParams();params.append('offset',this.settings.offset);params.append('limit',this.settings.limit);for(const[key,value]of urlParams.entries()){if(key!=='page'){params.append(key,value);}}
const path=window.location.pathname;let apiUrl=null;if(path.includes('/category/')){const categorySlug=path.split('/category/')[1].replace('/','');apiUrl=`/api/category/${categorySlug}/products/?${params.toString()}`;}else if(path==='/'||path===''){apiUrl=`/api/products/?${params.toString()}`;}else if(path.includes('/favorites/')){apiUrl=`/api/favorites/?${params.toString()}`;}
return apiUrl;},appendNewProducts(html){const tempContainer=document.createElement('div');tempContainer.innerHTML=html;const newProductItems=tempContainer.querySelectorAll('.product-item');newProductItems.forEach((item,index)=>{item.style.opacity='0';item.style.transform='translateY(20px)';this.elements.productsContainer.appendChild(item);setTimeout(()=>{item.style.transition='opacity 0.3s ease, transform 0.3s ease';item.style.opacity='1';item.style.transform='translateY(0)';},this.settings.animationDelay*(index+1));});if(typeof window.initFavoriteButtons==='function'){window.initFavoriteButtons();}},showLoader(){if(this.elements.loaderElement){this.elements.loaderElement.style.display='block';}},hideLoader(){if(this.elements.loaderElement){this.elements.loaderElement.style.display='none';}}};document.addEventListener('DOMContentLoaded',()=>{InfiniteScrollModule.init();});;document.addEventListener('DOMContentLoaded',function(){const tg=window.Telegram&&window.Telegram.WebApp;if(tg&&tg.BackButton){tg.BackButton.show();tg.onEvent('backButtonClicked',function(){if(tg.HapticFeedback){tg.HapticFeedback.impactOccurred('medium');}
window.history.back();});}
initDynamicFiltering();});function initDynamicFiltering(){const searchForm=document.getElementById('search-form');const searchInput=document.getElementById('search-input');const sortSelect=document.getElementById('sort-select');const citySelect=document.getElementById('city-select');const currencySelect=document.getElementById('currency-select');const resetButton=document.getElementById('reset-filters');const productsContainer=document.getElementById('products-container');const pathParts=window.location.pathname.split('/');const categorySlug=pathParts[pathParts.indexOf('category')+1];let currentFilters={q:searchInput.value||'',sort:sortSelect.value||'',city:citySelect.value||'',currency:currencySelect.value||'',offset:0,limit:20};function updateProductsList(){const loader=document.getElementById('loader');if(loader)loader.style.display='block';const params=new URLSearchParams();for(const[key,value]of Object.entries(currentFilters)){if(value)params.append(key,value);}
const apiUrl=`/api/category/${categorySlug}/products/?${params.toString()}`;const pageUrl=`${window.location.pathname}?${params.toString()}`;window.history.pushState({path:pageUrl},'',pageUrl);fetch(apiUrl).then(response=>{if(!response.ok)throw new Error('Ошибка загрузки данных');return response.json();}).then(data=>{productsContainer.innerHTML=data.html;productsContainer.dataset.offset=data.next_offset||0;productsContainer.dataset.hasMore=data.has_more;if(typeof window.initFavoriteButtons==='function'){window.initFavoriteButtons();}
if(data.html.trim()===''){productsContainer.innerHTML=`
                        <div class="col-12 text-center py-5">
                            <div class="empty-state">
                                <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
                                <p class="text-muted">По вашему запросу ничего не найдено</p>
                                <button id="clear-filters-btn" class="btn btn-outline-primary mt-2">Сбросить фильтры</button>
                            </div>
                        </div>
                    `;document.getElementById('clear-filters-btn').addEventListener('click',resetFilters);}
const countBadge=document.querySelector('.badge.bg-light.text-dark.rounded-pill');if(countBadge){countBadge.textContent=data.total_count;}}).catch(error=>{console.error('Ошибка:',error);const errorElement=document.getElementById('error-message');if(errorElement)errorElement.style.display='block';}).finally(()=>{if(loader)loader.style.display='none';updateActiveFilters();});}
function resetFilters(){searchInput.value='';sortSelect.value='';citySelect.value='';currencySelect.value='';currentFilters={q:'',sort:'',city:'',currency:'',offset:0,limit:20};updateProductsList();}
function updateActiveFilters(){let activeFiltersContainer=document.querySelector('.active-filters');if(!activeFiltersContainer){const filtersSection=document.querySelector('.filters-section');activeFiltersContainer=document.createElement('div');activeFiltersContainer.className='active-filters mt-3';filtersSection.appendChild(activeFiltersContainer);}
const hasActiveFilters=currentFilters.q||currentFilters.sort||currentFilters.city||currentFilters.currency;if(!hasActiveFilters){activeFiltersContainer.style.display='none';return;}
let filtersHTML='<div class="d-flex flex-wrap gap-2">';if(currentFilters.q){filtersHTML+=`
                <span class="badge bg-light text-dark text-decoration-none py-2 px-3 filter-badge" data-filter="q">
                    Поиск: ${currentFilters.q} <i class="bi bi-x-circle ms-1"></i>
                </span>
            `;}
if(currentFilters.sort){let sortText='';switch(currentFilters.sort){case'price_asc':sortText='Сначала дешевле';break;case'price_desc':sortText='Сначала дороже';break;case'date_desc':sortText='Сначала новые';break;case'date_asc':sortText='Сначала старые';break;}
filtersHTML+=`
                <span class="badge bg-light text-dark text-decoration-none py-2 px-3 filter-badge" data-filter="sort">
                    ${sortText} <i class="bi bi-x-circle ms-1"></i>
                </span>
            `;}
if(currentFilters.city){const cityOption=citySelect.querySelector(`option[value="${currentFilters.city}"]`);const cityName=cityOption?cityOption.textContent.trim():'Выбранный город';filtersHTML+=`
                <span class="badge bg-light text-dark text-decoration-none py-2 px-3 filter-badge" data-filter="city">
                    ${cityName} <i class="bi bi-x-circle ms-1"></i>
                </span>
            `;}
if(currentFilters.currency){const currencyOption=currencySelect.querySelector(`option[value="${currentFilters.currency}"]`);const currencyName=currencyOption?currencyOption.textContent.trim():'Выбранная валюта';filtersHTML+=`
                <span class="badge bg-light text-dark text-decoration-none py-2 px-3 filter-badge" data-filter="currency">
                    ${currencyName} <i class="bi bi-x-circle ms-1"></i>
                </span>
            `;}
filtersHTML+=`
            <button id="reset-filters" class="badge bg-danger text-white text-decoration-none py-2 px-3">
                Сбросить все <i class="bi bi-x-circle ms-1"></i>
            </button>
        `;filtersHTML+='</div>';activeFiltersContainer.innerHTML=filtersHTML;activeFiltersContainer.style.display='block';document.getElementById('reset-filters').addEventListener('click',resetFilters);document.querySelectorAll('.filter-badge').forEach(badge=>{badge.addEventListener('click',function(){const filterType=this.dataset.filter;switch(filterType){case'q':searchInput.value='';currentFilters.q='';break;case'sort':sortSelect.value='';currentFilters.sort='';break;case'city':citySelect.value='';currentFilters.city='';break;case'currency':currencySelect.value='';currentFilters.currency='';break;}
currentFilters.offset=0;updateProductsList();});});}
searchForm.addEventListener('submit',function(e){e.preventDefault();currentFilters.q=searchInput.value;currentFilters.offset=0;updateProductsList();});sortSelect.addEventListener('change',function(){currentFilters.sort=this.value;currentFilters.offset=0;updateProductsList();});citySelect.addEventListener('change',function(){currentFilters.city=this.value;currentFilters.offset=0;updateProductsList();});currencySelect.addEventListener('change',function(){currentFilters.currency=this.value;currentFilters.offset=0;updateProductsList();});if(resetButton){resetButton.addEventListener('click',resetFilters);}
document.addEventListener('click',function(e){const badge=e.target.closest('.filter-badge');if(badge){const filterType=badge.dataset.filter;switch(filterType){case'q':searchInput.value='';currentFilters.q='';break;case'sort':sortSelect.value='';currentFilters.sort='';break;case'city':citySelect.value='';currentFilters.city='';break;case'currency':currencySelect.value='';currentFilters.currency='';break;}
currentFilters.offset=0;updateProductsList();}});if(window.InfiniteScrollModule){const originalLoadMoreProducts=window.InfiniteScrollModule.loadMoreProducts;window.InfiniteScrollModule.loadMoreProducts=function(){if(this.settings.isLoading||!this.settings.hasMore)return;this.settings.isLoading=true;this.showLoader();const params=new URLSearchParams();for(const[key,value]of Object.entries(currentFilters)){if(value)params.append(key,value);}
params.set('offset',this.settings.offset);params.set('limit',this.settings.limit);const apiUrl=`/api/category/${categorySlug}/products/?${params.toString()}`;fetch(apiUrl).then(response=>{if(!response.ok)throw new Error('Ошибка загрузки данных');return response.json();}).then(data=>{if(data.html){this.appendNewProducts(data.html);this.settings.offset=data.next_offset||this.settings.offset;this.settings.hasMore=data.has_more;if(!this.settings.hasMore&&this.elements.endMessageElement){this.elements.endMessageElement.style.display='block';}}}).catch(error=>{console.error('Ошибка:',error);if(this.elements.errorElement){this.elements.errorElement.style.display='block';}}).finally(()=>{this.hideLoader();this.settings.isLoading=false;});};}
searchInput.addEventListener('input',function(){clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(()=>{currentFilters.q=this.value;currentFilters.offset=0;updateProductsList();},500);});searchInput.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();currentFilters.q=this.value;currentFilters.offset=0;updateProductsList();}});const backToTopButton=document.getElementById('back-to-top');if(backToTopButton){window.addEventListener('scroll',function(){if(window.pageYOffset>300){backToTopButton.style.display='flex';}else{backToTopButton.style.display='none';}});backToTopButton.addEventListener('click',function(){window.scrollTo({top:0,behavior:'smooth'});});}
const urlParams=new URLSearchParams(window.location.search);currentFilters={q:urlParams.get('q')||'',sort:urlParams.get('sort')||'',city:urlParams.get('city')||'',currency:urlParams.get('currency')||'',offset:0,limit:20};searchInput.value=currentFilters.q;sortSelect.value=currentFilters.sort;citySelect.value=currentFilters.city;currencySelect.value=currentFilters.currency;updateActiveFilters();function animateProductItems(){const productItems=document.querySelectorAll('.product-item');productItems.forEach((item,index)=>{item.style.opacity='0';item.style.transform='translateY(20px)';setTimeout(()=>{item.style.transition='opacity 0.3s ease, transform 0.3s ease';item.style.opacity='1';item.style.transform='translateY(0)';},50*index);});}
animateProductItems();const retryButton=document.getElementById('retry-button');if(retryButton){retryButton.addEventListener('click',function(){const errorElement=document.getElementById('error-message');if(errorElement){errorElement.style.display='none';}
updateProductsList();});}
window.addEventListener('resize',function(){});function showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`alert alert-${type} notification-toast`;notification.innerHTML=message;document.body.appendChild(notification);setTimeout(()=>{notification.style.transform='translateY(0)';notification.style.opacity='1';},10);setTimeout(()=>{notification.style.transform='translateY(-20px)';notification.style.opacity='0';setTimeout(()=>{notification.remove();},300);},3000);}
const notificationStyles=document.createElement('style');notificationStyles.textContent=`
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 250px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    `;document.head.appendChild(notificationStyles);function checkConnection(){if(!navigator.onLine){showNotification('Отсутствует подключение к интернету. Проверьте соединение и попробуйте снова.','warning');return false;}
return true;}
window.addEventListener('offline',function(){showNotification('Соединение с интернетом потеряно. Некоторые функции могут быть недоступны.','warning');});window.addEventListener('online',function(){showNotification('Соединение с интернетом восстановлено.','success');});};